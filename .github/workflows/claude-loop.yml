# ============================================
# Claude Code ìžìœ¨ Loop â€” GitHub Actions
# ============================================
# ì‚¬ìš©ë²•:
#   - ìˆ˜ë™ íŠ¸ë¦¬ê±°: Actions íƒ­ â†’ "Run workflow"
#   - ìžë™ ì‹¤í–‰: í‰ì¼ ì˜¤ì „ 9ì‹œ (KST)
#   - PR merge ì‹œ ìžë™ ì‹¤í–‰
#
# í•„ìš”í•œ GitHub Secrets:
#   - ANTHROPIC_API_KEY
#   - NOTION_API_KEY
#   - NOTION_TODO_DB_ID
#   - NOTION_PROJECT_PAGE_ID

name: Claude Code Loop

on:
  # ìˆ˜ë™ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'TODO ëª©ë¡ë§Œ í™•ì¸ (ì‹¤í–‰í•˜ì§€ ì•ŠìŒ)'
        required: false
        default: 'false'
        type: boolean

  # ìŠ¤ì¼€ì¤„: í‰ì¼ ì˜¤ì „ 9ì‹œ KST (UTC 0ì‹œ)
  schedule:
    - cron: '0 0 * * 1-5'

  # PR merge ì‹œ ìžë™ ì‹¤í–‰ (ìƒˆ TODOê°€ ìƒê²¼ì„ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ)
  pull_request:
    types: [closed]
    branches: [develop, main]

jobs:
  claude-loop:
    # PR merge íŠ¸ë¦¬ê±°ì¼ ë•ŒëŠ” ì‹¤ì œë¡œ mergeëœ ê²½ìš°ë§Œ ì‹¤í–‰
    if: >
      github.event_name != 'pull_request' ||
      github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    timeout-minutes: 60  # ìµœëŒ€ 1ì‹œê°„

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure Git
        run: |
          git config user.name "Claude Code Bot"
          git config user.email "claude-bot@baryonlabs.com"

      - name: Create .env
        run: |
          cat > .env << EOF
          NOTION_API_KEY=${{ secrets.NOTION_API_KEY }}
          NOTION_TODO_DB_ID=${{ secrets.NOTION_TODO_DB_ID }}
          NOTION_PROJECT_PAGE_ID=${{ secrets.NOTION_PROJECT_PAGE_ID }}
          GITHUB_REPO=${{ github.repository }}
          GITHUB_DEFAULT_BRANCH=develop
          EOF

      - name: Run Claude Code Loop
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "ðŸ” DRY RUN ëª¨ë“œ"
            chmod +x scripts/run-loop.sh
            ./scripts/run-loop.sh --dry-run
          else
            echo "ðŸš€ Loop ì‹¤í–‰"
            chmod +x scripts/run-loop.sh
            ./scripts/run-loop.sh
          fi
