name: Claude Code Loop

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'TODO 확인만 (실행 안 함)'
        type: boolean
        default: false
  schedule:
    - cron: '0 0 * * 1-5'  # 평일 09:00 KST

jobs:
  loop:
    if: github.event_name != 'pull_request' || github.event.pull_request.merged
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0, ref: develop }
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - run: npm install -g @anthropic-ai/claude-code
      - run: |
          git config user.name "Claude Code Bot"
          git config user.email "bot@baryonlabs.com"
      - run: |
          cat > .env << EOF
          NOTION_API_KEY=${{ secrets.NOTION_API_KEY }}
          NOTION_TODO_DB_ID=${{ secrets.NOTION_TODO_DB_ID }}
          NOTION_PROJECT_PAGE_ID=${{ secrets.NOTION_PROJECT_PAGE_ID }}
          GITHUB_REPO=${{ github.repository }}
          GITHUB_DEFAULT_BRANCH=develop
          EOF
      - run: |
          chmod +x scripts/run-loop.sh
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            ./scripts/run-loop.sh --dry-run
          else
            ./scripts/run-loop.sh
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
